{{define "job-details-content"}}
  {{template "dashboard-layout" .}}
{{end}}

{{define "dashboard-page-content"}}
  {{template "job-details" .}}
{{end}}

{{define "job-details"}}
<div class="sr-only" role="status" aria-live="polite" aria-atomic="true" id="sr-announcements"></div>
<div class="mx-0 md:max-w-6xl md:mx-auto">
  <div class="bg-slate-800 rounded-none md:rounded-xl shadow-lg overflow-hidden mb-6">
    <div class="px-4 py-4 sm:px-5 md:px-6 sm:py-5 border-b border-slate-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4">
      <div>
        <div id="job-header-display">
          <div class="flex items-center">
            <h2 class="text-xl md:text-2xl font-semibold text-white mr-2">{{.job.Title | html}}</h2>
            <button _="on click toggle .hidden on #job-header-display then toggle .hidden on #job-header-edit"
                    class="text-gray-400 hover:text-white flex items-center justify-center p-2.5 sm:p-2 min-w-[44px] min-h-[44px] -m-2.5 sm:-m-2"
                    aria-label="Edit job title and details">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
              </svg>
            </button>
          </div>
          <p class="text-gray-400 text-sm md:text-base">{{.job.Company.Name | html}}{{if .job.Location}} Â· {{.job.Location | html}}{{end}}</p>
        </div>

        <div id="job-header-edit" class="hidden space-y-2" role="form" aria-label="Edit job details form">
          <div>
            <label for="job-title-input" class="block text-sm font-medium text-gray-300 mb-1">Job Title</label>
            <input
              type="text"
              id="job-title-input"
              name="title"
              class="w-full px-3 py-2 rounded-md bg-slate-700 bg-opacity-70 border border-slate-600 text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
              value="{{.job.Title | html}}"
              aria-required="true"
            >
          </div>
          <div>
            <label for="job-company-input" class="block text-sm font-medium text-gray-300 mb-1">Company</label>
            <input
              type="text"
              id="job-company-input"
              name="company_name"
              class="w-full px-3 py-2 rounded-md bg-slate-700 bg-opacity-70 border border-slate-600 text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
              value="{{.job.Company.Name | html}}"
              aria-required="true"
            >
          </div>
          <div>
            <label for="job-location-input" class="block text-sm font-medium text-gray-300 mb-1">Location</label>
            <input
              type="text"
              id="job-location-input"
              name="location"
              class="w-full px-3 py-2 rounded-md bg-slate-700 bg-opacity-70 border border-slate-600 text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
              value="{{.job.Location | html}}"
            >
          </div>
          <div class="flex gap-2">
            <button
              class="px-4 py-2.5 sm:px-3 sm:py-1.5 bg-primary hover:bg-primary-dark text-white text-sm rounded-md"
              hx-put="/jobs/{{.jobID}}/basic"
              hx-headers='{"X-CSRF-Token": "{{.csrfToken}}"}'
              hx-include="#job-title-input, #job-company-input, #job-location-input"
              hx-target="#header-response"
              hx-swap="innerHTML"
              _="on htmx:afterRequest if event.detail.successful toggle .hidden on #job-header-display then toggle .hidden on #job-header-edit then wait 100ms then call window.location.reload()">
              Save Changes
            </button>
            <button
              class="px-4 py-2.5 sm:px-3 sm:py-1.5 bg-slate-600 hover:bg-slate-700 text-white text-sm rounded-md"
              _="on click toggle .hidden on #job-header-display then toggle .hidden on #job-header-edit"
              aria-label="Cancel editing job details">
              Cancel
            </button>
          </div>
          <div id="header-response" role="status" aria-live="polite" aria-atomic="true"></div>
        </div>
      </div>
      <div id="match-score-badge" class="px-3 md:px-4 py-1.5 {{matchColors .job.MatchScore}} rounded-full text-xs md:text-sm font-medium whitespace-nowrap">
        {{.job.GetMatchScoreString}}
      </div>
    </div>

    <div class="p-4 sm:p-5 md:p-6 grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 md:gap-8">
      <div class="lg:col-span-2 space-y-4 sm:space-y-5 md:space-y-6">
        <div>
          <h3 class="text-lg font-medium text-primary mb-3">Job Description</h3>
          <div class="text-gray-300 space-y-4">
            <p class="whitespace-pre-wrap leading-relaxed text-sm md:text-base">{{.job.Description | html}}</p>
          </div>
        </div>

        <div>
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-medium text-primary">Skills</h3>
            <button id="edit-skills-btn"
              class="px-4 py-2 sm:px-3 sm:py-1.5 bg-primary hover:bg-primary-dark text-white text-sm rounded-md flex items-center gap-2 min-h-[44px] sm:min-h-0"
              aria-label="Edit job skills"
              aria-expanded="false"
              aria-controls="skills-edit"
              _="on click
                 toggle .hidden on #skills-display
                 then toggle .hidden on #skills-edit
                 then if #skills-display matches .hidden
                      put 'Cancel' into me.lastChild
                      set @aria-expanded to 'true'
                 else
                      put 'Edit Skills' into me.lastChild
                      set @aria-expanded to 'false' end">
              <span>Edit Skills</span>
            </button>
          </div>

          <div id="skills-display" class="flex flex-wrap gap-2" role="list" aria-label="Required skills">
            {{range .job.RequiredSkills}}
            <span class="px-3 py-1.5 bg-slate-700 rounded-md text-sm text-primary" role="listitem">{{. | html}}</span>
            {{else}}
            <span class="text-gray-400">No skills listed</span>
            {{end}}
          </div>

          <div id="skills-edit" class="hidden">
            <div class="mb-2">
              <input
                type="text"
                id="skills-input"
                name="skills"
                class="w-full px-3 py-2 rounded-md bg-slate-700 bg-opacity-70 border border-slate-600 text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                placeholder="Enter skills separated by commas"
                value="{{range $i, $skill := .job.RequiredSkills}}{{if $i}}, {{end}}{{$skill | html}}{{end}}"
                aria-label="Skills list"
                aria-describedby="skills-help-text"
              >
              <p id="skills-help-text" class="text-xs text-gray-400 mt-1">Enter skills separated by commas (e.g., "Go, Docker, SQL")</p>
            </div>
            <div class="flex gap-2">
              <button
                class="px-4 py-2.5 sm:px-3 sm:py-1.5 bg-primary hover:bg-primary-dark text-white text-sm rounded-md"
                hx-put="/jobs/{{.jobID}}/skills"
                hx-headers='{"X-CSRF-Token": "{{.csrfToken}}"}'
                hx-include="#skills-input"
                hx-target="#skills-response"
                hx-swap="innerHTML"
                _="on htmx:afterRequest
                   if event.detail.successful
                     set skills to #skills-input.value
                     set skillsArray to skills.split(',')
                     set trimmedSkills to []
                     for skill in skillsArray
                       set trimmed to skill.trim()
                       if trimmed.length > 0
                         append trimmed to trimmedSkills
                       end
                     end
                     if trimmedSkills.length > 0
                       put '' into #skills-display then
                       for skill in trimmedSkills
                         make a <span.px-3.py-1.5.bg-slate-700.rounded-md.text-sm.text-primary.mr-2/>
                         put skill into the result
                         put the result at the end of #skills-display
                       end
                     else
                       make a <span.text-gray-400/> called noSkills
                       put 'No skills listed' into noSkills
                       put '' into #skills-display
                       put noSkills into #skills-display
                     end
                     trigger click on #edit-skills-btn
                   end">
                Save
              </button>
              <button
                class="px-4 py-2.5 sm:px-3 sm:py-1.5 bg-slate-600 hover:bg-slate-700 text-white text-sm rounded-md"
                _="on click trigger click on #edit-skills-btn">
                Cancel
              </button>
            </div>
          </div>

          <div id="skills-response" class="mt-2" role="status" aria-live="polite" aria-atomic="true"></div>
        </div>


        <div>
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-medium text-primary">Your Notes</h3>
            <button id="save-notes-btn"
              class="px-4 py-2 sm:px-3 sm:py-1.5 bg-primary hover:bg-primary-dark text-white text-sm rounded-md hidden min-h-[44px] sm:min-h-0"
              aria-label="Save your notes about this job"
              hx-put="/jobs/{{.jobID}}/notes"
              hx-headers='{"X-CSRF-Token": "{{.csrfToken}}"}'
              hx-include="#job-notes"
              hx-target="#notes-response"
              hx-swap="innerHTML">
              Save Notes
            </button>
          </div>
          <textarea
            id="job-notes"
            name="notes"
            class="w-full px-4 py-3 rounded-md bg-slate-700 bg-opacity-70 border border-slate-600 text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors text-sm md:text-base"
            rows="4"
            placeholder="Add your personal notes about this job..."
            _="on input remove .hidden from #save-notes-btn"
            aria-label="Your notes about this job"
          >{{.job.Notes | html}}</textarea>
          <div id="notes-response" class="mt-2" role="status" aria-live="polite" aria-atomic="true"></div>
        </div>
      </div>

      <div class="space-y-4 sm:space-y-5 md:space-y-6">
        <div class="bg-slate-700 bg-opacity-60 rounded-lg p-4 sm:p-5 space-y-3 sm:space-y-4">
          <h3 class="text-lg font-medium text-white">Job Details</h3>

          <div>
            <p class="text-gray-400 text-sm">Location</p>
            <p class="text-white">{{if .job.Location}}{{.job.Location | html}}{{else}}Not specified{{end}}</p>
          </div>

          <div>
            <p class="text-gray-400 text-sm">Job Type</p>
            <p class="text-white">{{.job.JobType.String}}</p>
          </div>

        </div>

        <div id="ai-actions-section" class="bg-slate-700 bg-opacity-60 rounded-lg p-4 sm:p-5">
          <h3 class="text-lg font-medium text-white mb-3">Application Status</h3>
          <select
            class="w-full px-3 py-2 rounded-md bg-slate-700 bg-opacity-70 border border-slate-600 text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors mb-4"
            aria-label="Application status"
            hx-put="/jobs/{{.jobID}}/status"
            hx-headers='{"X-CSRF-Token": "{{.csrfToken}}"}'
            hx-target="#status-response"
            hx-trigger="change"
            name="status"
          >
            <option value="interested" {{if eq .job.Status 0}}selected{{end}}>Interested</option>
            <option value="applied" {{if eq .job.Status 1}}selected{{end}}>Applied</option>
            <option value="interviewing" {{if eq .job.Status 2}}selected{{end}}>Interviewing</option>
            <option value="offered" {{if eq .job.Status 3}}selected{{end}}>Offer Received</option>
            <option value="rejected" {{if eq .job.Status 4}}selected{{end}}>Rejected</option>
            <option value="not_interested" {{if eq .job.Status 5}}selected{{end}}>Not Interested</option>
          </select>
          <div id="status-response" role="status" aria-live="polite" aria-atomic="true"></div>

          {{if .isCloudMode}}
          {{if and (ne .quotaCheck.Status.Limit -1) (not .isReanalysis) (not .quotaCheck.Allowed)}}
          <div class="w-full mb-3 p-3 bg-red-900 bg-opacity-30 border border-red-800 rounded-lg">
            <p class="text-red-400 text-sm font-medium">Monthly Limit Reached</p>
            <p class="text-gray-400 text-xs mt-1">You've used all {{.quotaCheck.Status.Limit}} job analyses this month. Limit resets on {{.quotaCheck.Status.ResetDate.Format "Jan 2"}}.</p>
          </div>
          {{end}}
          {{end}}
          
          <button id="analyze-button" class="w-full mb-3 py-3 sm:py-2.5 px-4 {{if and .isCloudMode (ne .quotaCheck.Status.Limit -1) (not .isReanalysis) (not .quotaCheck.Allowed)}}bg-gray-600 cursor-not-allowed{{else}}bg-primary hover:bg-primary-dark{{end}} text-white rounded-md text-sm font-medium transition-colors flex items-center justify-center gap-2 whitespace-nowrap min-h-[48px] sm:min-h-0"
                  aria-label="Analyze job match with your profile"
                  {{if and .isCloudMode (ne .quotaCheck.Status.Limit -1) (not .isReanalysis) (not .quotaCheck.Allowed)}}disabled{{else}}
                  hx-post="/jobs/{{.jobID}}/analyze"
                  hx-headers='{"X-CSRF-Token": "{{.csrfToken}}"}'
                  hx-target="#ai-analysis"
                  hx-target-error="#analyze-error"
                  hx-swap="innerHTML"
                  hx-indicator="#analyze-spinner"
                  hx-disable-elt="this"
                  hx-on:htmx:before-request="window.handleAIOperationStart(this, 'Analyzing...')"
                  hx-on:htmx:after-request="window.handleAIOperationEnd(this)"
                  hx-on:htmx:response-error="window.handleAIOperationEnd(this)"
                  _="on click put '<div class=&quot;text-center py-8&quot;><div class=&quot;animate-spin h-8 w-8 border-2 border-primary border-t-transparent rounded-full mx-auto&quot;></div><p class=&quot;mt-4 text-gray-400&quot;>Analyzing job requirements...</p></div>' into #ai-analysis"
                  {{end}}>
            <span id="analyze-spinner" class="htmx-indicator">
              <svg class="animate-spin h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
            <span id="analyze-icon" class="htmx-indicator:not(.htmx-request) block">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg>
            </span>
            <span class="button-text">
              {{if .isReanalysis}}
                Re-analyze Job (Free)
              {{else if .isCloudMode}}
                {{if eq .quotaCheck.Status.Limit -1}}
                  Analyze Match (Unlimited)
                {{else if .quotaCheck.Allowed}}
                  Analyze Match ({{.quotaRemaining}} left)
                {{else}}
                  Monthly Limit Reached
                {{end}}
              {{else}}
                Analyze Match
              {{end}}
            </span>
          </button>
          
          {{if .isCloudMode}}
          {{if ne .quotaCheck.Status.Limit -1}}
          <div class="w-full mb-3">
            <div class="flex justify-between text-xs text-gray-400 mb-1">
              <span>Monthly quota</span>
              <span>{{cappedQuota .quotaCheck.Status.Used .quotaCheck.Status.Limit}}/{{.quotaCheck.Status.Limit}} used</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
              <div class="{{if ge .quotaPercentage 100}}bg-red-500{{else if ge .quotaPercentage 90}}bg-yellow-500{{else}}bg-primary{{end}} rounded-full h-2 transition-all duration-300" style="width: {{if gt .quotaPercentage 100}}100{{else}}{{.quotaPercentage}}{{end}}%;"></div>
            </div>
          </div>
          {{else}}
          <div class="w-full mb-3">
            <div class="text-xs text-gray-400">
              <span>Admin access: Unlimited analyses</span>
            </div>
          </div>
          {{end}}
          {{end}}


          <button id="cover-letter-button" class="w-full mb-3 py-3 sm:py-2.5 px-4 bg-primary hover:bg-primary-dark text-white rounded-md text-sm font-medium transition-colors flex items-center justify-center gap-2 min-h-[48px] sm:min-h-0"
                  aria-label="Generate cover letter for this job"
                  hx-post="/jobs/{{.jobID}}/cover-letter"
                  hx-headers='{"X-CSRF-Token": "{{.csrfToken}}"}'
                  hx-target="#cover-letter-section"
                  hx-swap="innerHTML"
                  hx-indicator=".cover-letter-spinner"
                  hx-disable-elt="this"
                  hx-on:htmx:before-request="window.handleAIOperationStart(this, 'Generating Cover Letter...')"
                  hx-on:htmx:after-request="window.handleAIOperationEnd(this)"
                  hx-on:htmx:response-error="window.handleAIOperationEnd(this)">
            <svg class="cover-letter-spinner htmx-indicator animate-spin h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <svg class="cover-letter-icon h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <span class="button-text">Cover Letter</span>
          </button>


          <button id="cv-button" class="w-full mb-3 py-3 sm:py-2.5 px-4 bg-primary hover:bg-primary-dark text-white rounded-md text-sm font-medium transition-colors flex items-center justify-center gap-2 min-h-[48px] sm:min-h-0"
                  aria-label="Generate tailored resume for this job"
                  hx-post="/jobs/{{.jobID}}/cv"
                  hx-headers='{"X-CSRF-Token": "{{.csrfToken}}"}'
                  hx-target="#cv-section"
                  hx-swap="innerHTML"
                  hx-indicator=".cv-spinner"
                  hx-disable-elt="this"
                  hx-on:htmx:before-request="window.handleAIOperationStart(this, 'Generating Resume...')"
                  hx-on:htmx:after-request="window.handleAIOperationEnd(this)"
                  hx-on:htmx:response-error="window.handleAIOperationEnd(this)">
            <svg class="cv-spinner htmx-indicator animate-spin h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <svg class="cv-icon h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span class="button-text">Resume</span>
          </button>


          <a href="/jobs/{{.jobID}}/match-history" class="w-full mb-3 py-3 sm:py-2.5 px-4 bg-slate-600 hover:bg-slate-500 text-white rounded-md text-sm font-medium transition-colors flex items-center justify-center gap-2 min-h-[48px] sm:min-h-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Match History</span>
          </a>

          {{if .job.SourceURL}}
          <a href="{{.job.SourceURL}}" target="_blank" class="w-full mb-3 py-3 sm:py-2.5 px-4 bg-slate-600 hover:bg-slate-500 text-white rounded-md text-sm font-medium transition-colors flex items-center justify-center gap-2 min-h-[48px] sm:min-h-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
            <span>Original Posting</span>
          </a>
          {{end}}

          {{if .job.ApplicationURL}}
          <a href="{{.job.ApplicationURL}}" target="_blank" class="w-full mb-3 py-3 sm:py-2.5 px-4 bg-primary hover:bg-primary-dark text-white rounded-md text-sm font-medium transition-colors flex items-center justify-center gap-2 min-h-[48px] sm:min-h-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
            <span>Apply Now</span>
          </a>
          {{end}}

          <button
            id="delete-job-btn"
            class="w-full py-3 sm:py-2.5 px-4 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm font-medium transition-colors flex items-center justify-center gap-2 min-h-[48px] sm:min-h-0"
            aria-label="Delete this job listing"
            _="on click
               put {url: '/jobs/{{.jobID}}', method: 'DELETE', type: 'job'} into window.itemToDelete
               remove .hidden from #delete-modal-shared"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            <span>Delete Job</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="ai-analysis" role="region" aria-label="AI job match analysis"></div>

  <div id="cover-letter-section" role="region" aria-label="Generated cover letter"></div>

  <div id="cv-section" role="region" aria-label="Generated resume"></div>

</div>


<script src="/static/js/ai-helpers.js"></script>

<script src="/static/js/ai-operations.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener('htmx:afterRequest', function(evt) {
  const isAIContent = (
    evt.detail.target.id === 'ai-analysis' || 
    evt.detail.target.id === 'cover-letter-section' || 
    evt.detail.target.id === 'cv-section'
  ) && evt.detail.xhr.status === 200;

  if (isAIContent) {
    const errorContainers = ['analyze-error', 'cover-letter-error', 'cv-error'];
    errorContainers.forEach(id => {
      const element = document.getElementById(id);
      if (element) element.innerHTML = '';
    });

    const contentSections = ['ai-analysis', 'cover-letter-section', 'cv-section'];
    contentSections.forEach(id => {
      if (id !== evt.detail.target.id) {
        const element = document.getElementById(id);
        if (element) element.innerHTML = '';
      }
    });

    setTimeout(() => {
      window.scrollTo({
        top: document.documentElement.scrollHeight,
        behavior: 'smooth'
      });
    }, 300);
  }
});

document.addEventListener('DOMContentLoaded', function() {
  if (sessionStorage.getItem('scrollToAIActions') === 'true') {
    sessionStorage.removeItem('scrollToAIActions');
    setTimeout(() => {
      const aiActionsSection = document.getElementById('ai-actions-section');
      if (aiActionsSection) {
        aiActionsSection.scrollIntoView({behavior: 'smooth', block: 'start'});
      }
    }, 100);
  }
});

document.addEventListener('click', function(evt) {
  let target = evt.target;
  let action = target.getAttribute('data-action');

  while (!action && target.parentElement) {
    target = target.parentElement;
    action = target.getAttribute('data-action');
  }

  if (action === 'scroll-to-top') {
    evt.preventDefault();
    document.getElementById('job-header-display').scrollIntoView({behavior: 'smooth', block: 'start'});
  }
});
</script>

{{end}}
