{{define "layouts/base.html"}}
<!DOCTYPE html>
<html lang="en" hx-ext="response-targets">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="csrf-token" content="{{.csrfToken}}">
  <title>Vega AI â€¢ {{.title}}</title>
  <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/images/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/images/apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="/static/css/output.css" rel="stylesheet">
  <link href="/static/css/components.css" rel="stylesheet">
  <link href="/static/css/utilities.css" rel="stylesheet">
  <link href="/static/css/print.css" rel="stylesheet" media="print">
  <script src="https://unpkg.com/htmx.org@1.9.4"></script>
  <script src="https://unpkg.com/htmx.org/dist/ext/response-targets.js"></script>
  <script src="https://unpkg.com/hyperscript.org@0.9.12"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      htmx.config.responseTargetUnsetsError = true;
    });
  </script>
</head>
<body class="bg-slate-900 text-gray-100 font-sans">
  {{if eq .page "dashboard"}}
    <div class="min-h-screen bg-slate-900 flex flex-col">
      <div class="flex-1">
        {{template "dashboard-content" .}}
      </div>
      {{template "footer" .}}
    </div>
  {{else if eq .page "job-new"}}
    <div class="min-h-screen bg-slate-900 flex flex-col">
      <div class="flex-1">
        {{template "job-new-content" .}}
      </div>
      {{template "footer" .}}
    </div>
  {{else if eq .page "job-details"}}
    <div class="min-h-screen bg-slate-900 flex flex-col">
      <div class="flex-1">
        {{template "job-details-content" .}}
      </div>
      {{template "footer" .}}
    </div>
  {{else if eq .page "match-history"}}
    <div class="min-h-screen bg-slate-900 flex flex-col">
      <div class="flex-1">
        {{template "match-history-content" .}}
      </div>
      {{template "footer" .}}
    </div>
  {{else if eq .page "404"}}
    {{template "404-content" .}}
  {{else if eq .page "500"}}
    {{template "500-content" .}}
  {{else if eq .page "settings-home" }}
    <div class="min-h-screen bg-slate-900 flex flex-col">
      <div class="flex-1">
        {{template "settings-layout" .}}
      </div>
      {{template "footer" .}}
    </div>
  {{else if eq .page "settings-profile" }}
    <div class="min-h-screen bg-slate-900 flex flex-col">
      <div class="flex-1">
        {{template "settings-layout" .}}
      </div>
      {{template "footer" .}}
    </div>
  {{else if eq .page "settings-account" }}
    <div class="min-h-screen bg-slate-900 flex flex-col">
      <div class="flex-1">
        {{template "settings-layout" .}}
      </div>
      {{template "footer" .}}
    </div>
  {{else if eq .page "settings-search-preferences" }}
    <div class="min-h-screen bg-slate-900 flex flex-col">
      <div class="flex-1">
        {{template "settings-layout" .}}
      </div>
      {{template "footer" .}}
    </div>
  {{else if eq .page "settings-quotas" }}
    <div class="min-h-screen bg-slate-900 flex flex-col">
      <div class="flex-1">
        {{template "settings-layout" .}}
      </div>
      {{template "footer" .}}
    </div>
  {{else if eq .page "documents" }}
    <div class="min-h-screen bg-slate-900 flex flex-col">
      <div class="flex-1">
        {{template "documents-content" .}}
      </div>
      {{template "footer" .}}
    </div>
  {{else}}
    <div class="{{if eq .page "login"}}h-screen overflow-hidden{{else}}min-h-screen{{end}} flex {{if eq .page "home"}}flex-col{{end}} items-center justify-center relative overflow-hidden">

      <div class="absolute inset-0 z-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900"></div>

      <div class="relative z-10 w-full {{if eq .page "home"}}flex flex-col{{else}}h-full{{end}}">
        {{if eq .page "home"}}
          <div class="min-h-screen flex flex-col items-center justify-center flex-1">
            {{template "home-content" .}}
          </div>
          {{template "footer" .}}
        {{else if eq .page "login"}}
          <div class="w-full h-full flex relative">
            <div class="absolute inset-0 hidden lg:block">
              <img src="/static/images/login/team-meeting.jpg" 
                   alt="Diverse team in meeting" 
                   class="w-full h-full object-cover">
            </div>
            <div class="hidden lg:block lg:w-1/2 relative">
              <div class="absolute inset-0 bg-gradient-to-r from-slate-900/80 via-slate-900/75 to-slate-900/70"></div>
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-center px-8">
                  <h2 class="text-5xl font-bold text-white mb-4">Land Your Dream Job</h2>
                  <p class="text-xl text-white/90">Join other job seekers who use AI to optimize their job search</p>
                </div>
              </div>
            </div>
            <div class="w-full lg:w-1/2 flex items-center justify-center py-0 sm:py-8 px-0 sm:px-4 relative">
              <div class="absolute inset-0 bg-slate-900 sm:bg-slate-900/95 backdrop-blur-sm"></div>
              <div class="w-full h-full sm:h-auto relative z-10">
                {{template "login-content" .}}
              </div>
            </div>
          </div>
        {{else}}
          <div class="z-10 text-white">Unknown page template</div>
        {{end}}
      </div>
    </div>
  {{end}}


  {{template "delete-modal" .}}


  <script>

    window.showToast = function(message, type = 'success', duration = 3000, id = null) {
      const container = document.getElementById('notification-container');
      if (!container) {
        console.error('Notification container not found');
        return;
      }
      
      const toastId = id || `${type}-${message.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;
      
      const existingToast = container.querySelector(`[data-toast-id="${toastId}"]`);
      if (existingToast) {
          const existingTimer = existingToast.toastTimer;
        if (existingTimer) {
          clearTimeout(existingTimer);
        }
        existingToast.remove();
      }
      
      const maxToasts = 5;
      const currentToasts = container.querySelectorAll('.toast-notification');
      if (currentToasts.length >= maxToasts) {
        const oldestToast = currentToasts[currentToasts.length - 1];
        if (oldestToast.toastTimer) {
          clearTimeout(oldestToast.toastTimer);
        }
        oldestToast.remove();
      }
      
      const toast = document.createElement('div');
      toast.classList.add('toast-notification');
      toast.setAttribute('data-toast-type', type);
      toast.setAttribute('data-toast-id', toastId);

      const baseClasses = 'px-3 sm:px-4 py-2 sm:py-3 rounded-lg shadow-2xl border pointer-events-auto animate-slide-in-right backdrop-blur-sm w-full sm:w-auto';
      const typeClasses = {
        success: 'bg-emerald-900/80 border-emerald-700 text-emerald-100',
        error: 'bg-red-900/80 border-red-700 text-red-100',
        warning: 'bg-yellow-900/80 border-yellow-700 text-yellow-100',
        info: 'bg-blue-900/80 border-blue-700 text-blue-100'
      };

      toast.className = `${baseClasses} ${typeClasses[type] || typeClasses.info}`;

      const span = document.createElement('span');
      span.className = 'text-sm font-medium block text-center';
      span.textContent = message;
      toast.appendChild(span);

      container.appendChild(toast);

      toast.toastTimer = setTimeout(() => {
        toast.classList.remove('animate-slide-in-right');
        toast.classList.add('animate-slide-out-right');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, duration);
    }

    let hasUnsavedChanges = false;

    function trackFormChanges() {
      const forms = document.querySelectorAll('form');
      forms.forEach(form => {
        const formData = new FormData(form);
        const originalData = new Map();

        for (let [key, value] of formData.entries()) {
          originalData.set(key, value);
        }

        const inputs = form.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
          input.addEventListener('input', () => {
            const currentData = new FormData(form);
            let changed = false;

            for (let [key, value] of currentData.entries()) {
              if (originalData.get(key) !== value) {
                changed = true;
                break;
              }
            }

            hasUnsavedChanges = changed;
          });
        });
      });
    }

    function setupUnsavedChangesWarning() {
      window.addEventListener('beforeunload', (e) => {
        if (hasUnsavedChanges) {
          e.preventDefault();
          e.returnValue = '';
          return '';
        }
      });

      document.addEventListener('submit', () => {
        hasUnsavedChanges = false;
      });

      document.body.addEventListener('htmx:afterRequest', (event) => {
        if (event.detail.xhr.status >= 200 && event.detail.xhr.status < 300) {
          hasUnsavedChanges = false;
        }
      });
    }

    function formatUTCDates() {
      const timeElements = document.querySelectorAll('.utc-time');

      timeElements.forEach(element => {
        const utcDate = element.getAttribute('data-utc');
        const format = element.getAttribute('data-format') || 'full';

        if (utcDate) {
          const date = new Date(utcDate);

          if (isNaN(date)) return;

          let formattedDate = '';

          if (format === 'full') {
            const datePart = date.toLocaleDateString(undefined, {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });

            const timePart = date.toLocaleTimeString(undefined, {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });

            formattedDate = `${datePart} at ${timePart}`;
          } else if (format === 'date') {
            formattedDate = date.toLocaleDateString(undefined, {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
          } else if (format === 'time') {
            formattedDate = date.toLocaleTimeString(undefined, {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
          }

          element.textContent = formattedDate;
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      formatUTCDates();
      trackFormChanges();
      setupUnsavedChangesWarning();
      
      document.body.addEventListener('showToast', function(evt) {
        if (evt.detail && evt.detail.message) {
          window.showToast(evt.detail.message, evt.detail.type || 'info', evt.detail.duration || 3000);
        }
      });
    });
    document.body.addEventListener('htmx:afterSwap', function(event) {
      formatUTCDates();
      trackFormChanges();
    });

    document.addEventListener('DOMContentLoaded', function() {
      if (typeof htmx !== 'undefined') {
        document.body.addEventListener('htmx:beforeSwap', function(event) {
          if (event.detail.xhr.status === 404) {
            const contentType = event.detail.xhr.getResponseHeader('content-type');
            if (contentType && contentType.includes('text/html') && event.detail.xhr.responseText.includes('404-content')) {
              window.location.href = event.detail.pathInfo.requestPath;
              event.detail.shouldSwap = false;
              return;
            }
          } else if (event.detail.xhr.status === 401 || event.detail.xhr.status === 400 || event.detail.xhr.status === 403) {
            // Check if the form has a data attribute indicating it shouldn't swap on error
            const shouldNotSwapOnError = event.detail.elt && 
                                        event.detail.elt.hasAttribute('data-no-swap-on-error');
            
            if (!shouldNotSwapOnError) {
              event.detail.shouldSwap = true;
              event.detail.isError = false;
            }
          } else if (event.detail.xhr.status >= 500) {
            event.detail.shouldSwap = false;
            if (event.detail.target) {
              event.detail.target.innerHTML = `
                <div class="bg-red-900 bg-opacity-50 border border-red-700 text-red-200 p-3 rounded-md mb-3 text-sm" _="on load wait 5s then transition opacity to 0 over 0.5s then remove me">
                  <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-red-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>Something went wrong. Please try again later.</span>
                  </div>
                </div>
              `;
            }
          }
        });

        document.body.addEventListener('htmx:responseError', function(event) {
          const spinner = document.getElementById('spinner');
          if (spinner) {
            spinner.classList.add('htmx-hide');
          }
          
          if (event.detail.xhr.status === 403) {
            try {
              const response = JSON.parse(event.detail.xhr.responseText);
              if (response.error) {
                showToast(response.error, 'error');
              } else {
                showToast('Access denied. Please check your credentials or try again.', 'error');
              }
            } catch (e) {
              showToast('Access denied. Please check your credentials or try again.', 'error');
            }
          } else if (event.detail.xhr.status === 404) {
            showToast('The requested item was not found', 'error');
          } else if (event.detail.xhr.status === 500) {
            showToast('Something went wrong. Please try again later.', 'error');
          } else if (event.detail.xhr.status === 0) {
            showToast('Connection error. Please check your internet connection.', 'error');
          }
        });
      }
    });

  window.showNotification = function(message, type = 'info', title = null) {
    showToast(message, type);
  };

  </script>

  <script src="/static/js/focus-management.js"></script>
  {{if eq .page "login"}}
  <script src="/static/js/auth-validation.js"></script>
  {{if .error}}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (window.showToast) {
        window.showToast('{{.error}}', 'error');
      }
    });
  </script>
  {{end}}
  {{end}}
  {{if eq .page "settings-profile"}}
  <script src="/static/js/skills-management.js"></script>
  <script src="/static/js/cv-upload.js"></script>
  <script src="/static/js/profile-scroll.js"></script>
  {{end}}
  {{if eq .page "settings-search-preferences"}}
  <script src="/static/js/skills-management.js"></script>
  {{end}}
  <div id="notification-container" class="fixed right-2 sm:right-4 bottom-4 left-2 sm:left-auto z-50 flex flex-col-reverse gap-2 pointer-events-none sm:max-w-sm">
  </div>
</body>
</html>
{{end}}