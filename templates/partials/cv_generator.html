<div class="bg-slate-800 rounded-none md:rounded-xl shadow-lg mb-6">
  <div class="px-4 md:px-6 py-4 md:py-5 border-b border-slate-700">
    <h3 class="text-lg md:text-xl font-semibold text-white flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      Resume
    </h3>
  </div>
  <div class="p-4 md:p-6 space-y-4 md:space-y-6">
    <div class="bg-slate-700 bg-opacity-60 rounded-lg p-4 md:p-5">
      <div class="flex flex-col md:flex-row md:justify-end md:items-center gap-3 md:gap-4 mb-4">
        <div class="flex gap-2 w-full md:w-auto">
          <button class="flex-1 md:flex-none px-3 py-2 bg-slate-600 hover:bg-slate-700 text-white text-sm rounded-md transition-colors"
                  onclick="saveResumeToDocuments()">
            Save
          </button>
          <button class="flex-1 md:flex-none px-3 py-2 bg-primary hover:bg-primary-dark text-white text-sm rounded-md transition-colors"
                  onclick="downloadResumePDF()">
            Download
          </button>
        </div>
      </div>
      <p class="text-xs text-yellow-500 mb-2 text-right md:hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        For best results, view on desktop
      </p>

      <div class="bg-blue-900 bg-opacity-20 border border-blue-700 rounded-lg p-3 mb-4 text-xs">
        <div class="flex items-start space-x-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-400 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div class="text-blue-200">
            <div class="font-medium mb-1">Editing Tips:</div>
            <ul class="space-y-1 text-blue-300">
              <li>‚Ä¢ Click any section to edit text directly</li>
              <li>‚Ä¢ Press <kbd class="px-1 py-0.5 bg-blue-800 rounded text-xs">Enter</kbd> for new line</li>
              <li>‚Ä¢ Use the <span class="px-2 py-0.5 bg-primary rounded text-xs">Bullet</span> button to add bullet points in work experience</li>
              <li>‚Ä¢ Use the üóëÔ∏è button to delete sections</li>
              <li>‚Ä¢ Changes appear in your downloaded PDF</li>
            </ul>
          </div>
        </div>
      </div>

      <div id="resume-content" class="bg-white text-gray-800 p-4 md:p-6 rounded-md text-xs leading-relaxed min-h-[300px] md:min-h-[400px] overflow-x-auto break-words max-w-full">
        <div class="mb-4">
          <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-1" contenteditable="true">{{.GeneratedCV.PersonalInfo.FirstName | html}} {{.GeneratedCV.PersonalInfo.LastName | html}}</h2>
          <p class="text-sm md:text-base text-gray-700 mb-1" contenteditable="true">{{.GeneratedCV.PersonalInfo.Title | html}}</p>
          <div class="text-xs text-gray-600">
            {{if .GeneratedCV.PersonalInfo.Location}}<span contenteditable="true">{{.GeneratedCV.PersonalInfo.Location | html}}</span>{{end}}
            {{if and .GeneratedCV.PersonalInfo.Location (or .GeneratedCV.PersonalInfo.Email .GeneratedCV.PersonalInfo.Phone .GeneratedCV.PersonalInfo.LinkedIn)}} | {{end}}
            {{if .GeneratedCV.PersonalInfo.Email}}<span contenteditable="true">{{.GeneratedCV.PersonalInfo.Email | html}}</span>{{end}}
            {{if and .GeneratedCV.PersonalInfo.Email (or .GeneratedCV.PersonalInfo.Phone .GeneratedCV.PersonalInfo.LinkedIn)}} | {{end}}
            {{if .GeneratedCV.PersonalInfo.Phone}}<span contenteditable="true">{{.GeneratedCV.PersonalInfo.Phone | html}}</span>{{end}}
            {{if and .GeneratedCV.PersonalInfo.Phone .GeneratedCV.PersonalInfo.LinkedIn}} | {{end}}
            {{if .GeneratedCV.PersonalInfo.LinkedIn}}<span contenteditable="true">{{.GeneratedCV.PersonalInfo.LinkedIn | html}}</span>{{end}}
          </div>
        </div>

        {{if .GeneratedCV.PersonalInfo.Summary}}
        <div class="resume-section mb-4" data-section="summary">
          <div class="flex justify-between items-center mb-0.5">
            <h3 class="text-sm font-semibold text-gray-900 border-b border-gray-300 pb-0.5 flex-grow">Professional Summary</h3>
            <button onclick="deleteSection(this)" class="ml-2 text-red-500 hover:text-red-700 text-xs print:hidden">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
          <p class="text-xs text-gray-700 leading-relaxed mt-1" contenteditable="true">{{.GeneratedCV.PersonalInfo.Summary | html}}</p>
        </div>
        {{end}}

        <div class="resume-section mb-4" data-section="skills">
          <div class="flex justify-between items-center mb-0.5">
            <h3 class="text-sm font-semibold text-gray-900 border-b border-gray-300 pb-0.5 flex-grow">Skills</h3>
            <button onclick="deleteSection(this)" class="ml-2 text-red-500 hover:text-red-700 text-xs print:hidden">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
          <div id="skills-container" class="text-xs text-gray-700 leading-relaxed mt-1" contenteditable="true">{{range $i, $skill := .GeneratedCV.Skills}}{{if $i}}, {{end}}{{$skill | html}}{{end}}</div>
        </div>

        {{if .GeneratedCV.WorkExperience}}
        <div class="resume-section mb-4" data-section="experience">
          <div class="flex justify-between items-center mb-1">
            <h3 class="text-sm font-semibold text-gray-900 border-b border-gray-300 pb-0.5 flex-grow">Work Experience</h3>
            <button onclick="deleteSection(this)" class="ml-2 text-red-500 hover:text-red-700 text-xs print:hidden">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
          {{range .GeneratedCV.WorkExperience}}
          <div class="mb-3">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="text-xs font-semibold text-gray-900 inline" contenteditable="true">{{.Title | html}}</h4>
              </div>
              <span class="text-xs text-gray-600 flex-shrink-0 ml-2" contenteditable="true">{{.StartDate}} - {{.EndDate}}</span>
            </div>
            <p class="text-xs text-gray-700" contenteditable="true">{{.Company | html}}{{if .Location}} ‚Äì <span class="italic text-gray-600">{{.Location | html}}</span>{{end}}</p>
            <div class="text-xs text-gray-700 whitespace-pre-wrap mt-1 leading-relaxed" contenteditable="true" data-newline-support="true">{{.Description | html}}</div>
            <div class="mt-1 print:hidden">
              <button onclick="addBulletPointToField(this)" class="cv-button-compact bg-primary hover:bg-primary-dark text-white rounded transition-colors" title="Add bullet point">
                Bullet
              </button>
            </div>
          </div>
          {{end}}
        </div>
        {{end}}

        {{if .GeneratedCV.Education}}
        <div class="resume-section mb-4" data-section="education">
          <div class="flex justify-between items-center mb-1">
            <h3 class="text-sm font-semibold text-gray-900 border-b border-gray-300 pb-0.5 flex-grow">Education</h3>
            <button onclick="deleteSection(this)" class="ml-2 text-red-500 hover:text-red-700 text-xs print:hidden">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
          {{range .GeneratedCV.Education}}
          <div class="mb-2">
            <div class="flex justify-between items-start">
              <h4 class="text-xs font-semibold text-gray-900" contenteditable="true">{{.Degree}}{{if .FieldOfStudy}} in {{.FieldOfStudy}}{{end}}</h4>
              <span class="text-xs text-gray-600 flex-shrink-0 ml-2" contenteditable="true">{{.StartDate}} - {{.EndDate}}</span>
            </div>
            <p class="text-xs text-gray-700" contenteditable="true">{{.Institution}}</p>
          </div>
          {{end}}
        </div>
        {{end}}

        {{if .GeneratedCV.Certifications}}
        <div class="resume-section mb-4" data-section="certifications">
          <div class="flex justify-between items-center mb-1">
            <h3 class="text-sm font-semibold text-gray-900 border-b border-gray-300 pb-0.5 flex-grow">Certifications</h3>
            <button onclick="deleteSection(this)" class="ml-2 text-red-500 hover:text-red-700 text-xs print:hidden">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
          {{range .GeneratedCV.Certifications}}
          <div class="mb-2">
            <div class="flex justify-between items-start">
              <h4 class="text-xs font-semibold text-gray-900" contenteditable="true">{{.Name}}</h4>
              <span class="text-xs text-gray-600 flex-shrink-0 ml-2" contenteditable="true">{{.IssueDate}}{{if .ExpiryDate}} - {{.ExpiryDate}}{{end}}</span>
            </div>
            <p class="text-xs text-gray-700" contenteditable="true">{{.IssuingOrg}}{{if .CredentialID}} ‚Ä¢ {{.CredentialID}}{{end}}</p>
          </div>
          {{end}}
        </div>
        {{end}}

        <div class="mt-2 text-center print:hidden">
          <button onclick="showAddSectionModal()" class="cv-button-compact bg-primary hover:bg-primary-dark text-white rounded-md transition-colors">
            Add Section
          </button>
        </div>
      </div>

      <div id="mobile-edit-controls" class="mt-4 md:hidden">
        <button class="w-full py-3 px-4 bg-primary hover:bg-primary-dark text-white rounded-md font-medium mb-3"
                onclick="enableMobileEdit()">
          ‚úèÔ∏è Edit Resume
        </button>
        <div id="mobile-edit-buttons" class="hidden flex gap-2">
          <button class="flex-1 py-3 px-4 bg-primary hover:bg-primary-dark text-white rounded-md font-medium"
                  onclick="saveMobileEdit()">
            Save
          </button>
          <button class="flex-1 py-3 px-4 bg-slate-600 hover:bg-slate-700 text-white rounded-md font-medium"
                  onclick="cancelMobileEdit()">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <div class="bg-slate-700 bg-opacity-60 rounded-lg p-3 md:p-4">
      <h5 class="text-xs md:text-sm font-medium text-gray-300 mb-2">Generated for</h5>
      <p class="text-white text-sm md:text-base">{{.GeneratedCV.JobTitle}}</p>
      <p class="text-gray-400 text-xs md:text-sm mt-1">{{.GeneratedCV.GeneratedAt.Format "Jan 2, 2006 at 3:04 PM"}}</p>
    </div>

    <div class="bg-blue-900 bg-opacity-30 border border-blue-800 rounded-lg p-4 md:p-5">
      <h4 class="text-base md:text-lg font-medium text-blue-400 mb-2">Next Steps</h4>
      <p class="text-gray-300 mb-3 text-sm md:text-base">Your Resume has been generated and tailored to the job. Review it carefully and make any necessary edits before downloading.</p>
      <div class="flex flex-col md:flex-row gap-2">
        <button class="hidden md:block px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-md text-sm transition-colors"
                onclick="editResume()">
          Edit
        </button>
        <button class="w-full md:w-auto px-4 py-3 md:py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-md text-sm transition-colors"
                onclick="scrollToAIActions()">
          Back to Top
        </button>
      </div>
    </div>
  </div>
</div>



<div id="add-section-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden"
     _="on keydown[key=='Escape'] from window add .hidden to me
        on click if event.target.id == 'add-section-modal' add .hidden to me">
  <div class="bg-slate-800 rounded-lg shadow-lg p-6 max-w-md w-full mx-4 border border-slate-700">
    <h3 class="text-xl font-semibold text-white mb-4">Add New Section</h3>
    <p class="text-gray-300 mb-4">Select a section type to add to your Resume:</p>
    <div class="space-y-2">
      <button onclick="addCustomSection('Certifications'); hideAddSectionModal();" class="w-full text-left px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition-colors">Certifications</button>
      <button onclick="addCustomSection('Projects'); hideAddSectionModal();" class="w-full text-left px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition-colors">Projects</button>
      <button onclick="addCustomSection('Publications'); hideAddSectionModal();" class="w-full text-left px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition-colors">Publications</button>
      <button onclick="addCustomSection('Languages'); hideAddSectionModal();" class="w-full text-left px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition-colors">Languages</button>
      <button onclick="addCustomSection('Awards'); hideAddSectionModal();" class="w-full text-left px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition-colors">Awards</button>
      <button onclick="addCustomSection('Volunteer Experience'); hideAddSectionModal();" class="w-full text-left px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition-colors">Volunteer Experience</button>
      <button onclick="addCustomSection('References'); hideAddSectionModal();" class="w-full text-left px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition-colors">References</button>
    </div>
    <div class="mt-4 flex justify-end">
      <button onclick="hideAddSectionModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition-colors">Cancel</button>
    </div>
  </div>
</div>

<script type="application/json" id="resume-json-data">
{
  "isValid": {{.GeneratedCV.IsValid}},
  "personalInfo": {
    "firstName": "{{.GeneratedCV.PersonalInfo.FirstName}}",
    "lastName": "{{.GeneratedCV.PersonalInfo.LastName}}",
    "email": "{{.GeneratedCV.PersonalInfo.Email}}",
    "phone": "{{.GeneratedCV.PersonalInfo.Phone}}",
    "linkedin": "{{.GeneratedCV.PersonalInfo.LinkedIn}}",
    "location": "{{.GeneratedCV.PersonalInfo.Location}}",
    "title": "{{.GeneratedCV.PersonalInfo.Title}}",
    "summary": "{{.GeneratedCV.PersonalInfo.Summary}}"
  },
  "workExperience": [
    {{range $i, $exp := .GeneratedCV.WorkExperience}}{{if $i}},{{end}}
    {
      "company": "{{$exp.Company}}",
      "title": "{{$exp.Title}}",
      "location": "{{$exp.Location}}",
      "startDate": "{{$exp.StartDate}}",
      "endDate": "{{$exp.EndDate}}",
      "description": "{{$exp.Description}}"
    }{{end}}
  ],
  "education": [
    {{range $i, $edu := .GeneratedCV.Education}}{{if $i}},{{end}}
    {
      "institution": "{{$edu.Institution}}",
      "degree": "{{$edu.Degree}}",
      "fieldOfStudy": "{{$edu.FieldOfStudy}}",
      "startDate": "{{$edu.StartDate}}",
      "endDate": "{{$edu.EndDate}}"
    }{{end}}
  ],
  "certifications": [
    {{range $i, $cert := .GeneratedCV.Certifications}}{{if $i}},{{end}}
    {
      "name": "{{$cert.Name}}",
      "issuingOrg": "{{$cert.IssuingOrg}}",
      "issueDate": "{{$cert.IssueDate}}",
      "expiryDate": "{{$cert.ExpiryDate}}",
      "credentialId": "{{$cert.CredentialID}}",
      "credentialUrl": "{{$cert.CredentialURL}}"
    }{{end}}
  ],
  "skills": [{{range $i, $skill := .GeneratedCV.Skills}}{{if $i}}, {{end}}"{{$skill}}"{{end}}]
}
</script>

<script>
(function() {
  // Track if PDF is being generated to prevent double-clicks
  let isGeneratingPDF = false;

  window.downloadResumePDF = function() {
    // Prevent multiple simultaneous PDF generations
    if (isGeneratingPDF) {
      return;
    }

    if (!AIHelpers.validateContentElement('resume-content', 'Resume content')) {
      return;
    }

    // Set loading state
    isGeneratingPDF = true;
    const button = event.target;
    const originalText = button.innerText;
    button.innerText = 'Generating...';
    button.disabled = true;

    // First save the document, then download
    saveResumeToDocuments(true).then(() => {
      try {
        // Check if jsPDF is available
        if (typeof window.jspdf === 'undefined') {
          throw new Error('jsPDF library not loaded. Please check your internet connection and try again.');
        }

        // Check if resume content exists
        const resumeElement = document.getElementById('resume-content');
        if (!resumeElement) {
          throw new Error('Resume content not found. Please refresh the page and try again.');
        }

        // Use centralized PDF generator for consistency
        if (window.PDFGenerator && window.PDFGenerator.generateResumePDFFromData) {
          const resumeData = extractResumeData();
          const jobTitle = {{if .JobTitle}}"{{.JobTitle}}"{{else}}""{{end}};
          const companyName = {{if .CompanyName}}"{{.CompanyName}}"{{else}}""{{end}};
          window.PDFGenerator.generateResumePDFFromData(resumeData, {{.JobID}}, jobTitle, companyName);
        } else {
          throw new Error('PDF generator not loaded. Please refresh the page.');
        }

        // Show success notification
        if (typeof window.showNotification === 'function') {
          window.showNotification('Your resume has been downloaded successfully!', 'success', 'Download Complete');
        }
      } catch (error) {
        console.error('PDF generation error:', error);

        let errorMessage = 'Unable to download your resume right now. Please try again in a moment.';
        if (error.message.includes('jsPDF library')) {
          errorMessage = 'Download temporarily unavailable. Please refresh the page and try again.';
        } else if (error.message.includes('Resume content not found')) {
          errorMessage = 'Your resume content couldn\'t be found. Please refresh the page and try again.';
        }

        if (typeof window.showNotification === 'function') {
          window.showNotification(errorMessage, 'error', 'Download Failed');
        }
      } finally {
        // Reset button state
        isGeneratingPDF = false;
        button.innerText = originalText;
        button.disabled = false;
      }
    }).catch(error => {
      // If save fails, still allow download
      console.error('Save failed, proceeding with download:', error);
      try {
        // Use centralized PDF generator for consistency
        if (window.PDFGenerator && window.PDFGenerator.generateResumePDFFromData) {
          const resumeData = extractResumeData();
          const jobTitle = {{if .JobTitle}}"{{.JobTitle}}"{{else}}""{{end}};
          const companyName = {{if .CompanyName}}"{{.CompanyName}}"{{else}}""{{end}};
          window.PDFGenerator.generateResumePDFFromData(resumeData, {{.JobID}}, jobTitle, companyName);
        } else {
          throw new Error('PDF generator not loaded. Please refresh the page.');
        }
        if (typeof window.showNotification === 'function') {
          window.showNotification('Your resume has been downloaded successfully!', 'success', 'Download Complete');
        }
      } catch (downloadError) {
        console.error('PDF generation error:', downloadError);
        if (typeof window.showNotification === 'function') {
          window.showNotification('Unable to download your resume. Please try again.', 'error', 'Download Failed');
        }
      } finally {
        isGeneratingPDF = false;
        button.innerText = originalText;
        button.disabled = false;
      }
    });
  }

  // generateTextPDF function removed - using centralized PDF generator instead
  // The centralized generator in /static/js/pdf-generator.js provides:
  // - Consistent styling between job details and documents hub
  // - Proper file naming: [company]-[position]-resume.pdf
  // - Better maintainability with single source of truth


window.editResume = function() {
  const content = document.getElementById('resume-content');

  // Make all editable elements visually distinct
  content.querySelectorAll('[contenteditable="true"]').forEach(elem => {
    elem.style.border = '1px dashed #3b82f6';
    elem.style.padding = '2px';
  });

  // Add save button
  const parent = content.parentElement;
  let saveBtn = parent.querySelector('.resume-save-btn');
  if (!saveBtn) {
    saveBtn = document.createElement('button');
    saveBtn.innerText = 'Save';
    saveBtn.className = 'resume-save-btn mt-2 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-md text-sm transition-colors';
    saveBtn.onclick = function() {
      content.querySelectorAll('[contenteditable="true"]').forEach(elem => {
        elem.style.border = 'none';
        elem.style.padding = '0';
      });
      this.remove();
    };
    parent.appendChild(saveBtn);
  }
}

// Mobile-specific editing functions
window.enableMobileEdit = function() {
  const content = document.getElementById('resume-content');
  const editButtons = document.getElementById('mobile-edit-buttons');

  content.querySelectorAll('[contenteditable="true"]').forEach(elem => {
    elem.style.border = '1px dashed #3b82f6';
    elem.style.padding = '2px';
  });

  editButtons.classList.remove('hidden');
  editButtons.classList.add('flex');

  editButtons.previousElementSibling.style.display = 'none';
}

window.saveMobileEdit = function() {
  const content = document.getElementById('resume-content');
  const editButtons = document.getElementById('mobile-edit-buttons');

  content.querySelectorAll('[contenteditable="true"]').forEach(elem => {
    elem.style.border = 'none';
    elem.style.padding = '0';
  });

  editButtons.classList.add('hidden');
  editButtons.classList.remove('flex');

  editButtons.previousElementSibling.style.display = 'block';
}

window.cancelMobileEdit = function() {
  const content = document.getElementById('resume-content');
  const editButtons = document.getElementById('mobile-edit-buttons');

  content.querySelectorAll('[contenteditable="true"]').forEach(elem => {
    elem.style.border = 'none';
    elem.style.padding = '0';
  });

  location.reload();

  editButtons.classList.add('hidden');
  editButtons.classList.remove('flex');

  editButtons.previousElementSibling.style.display = 'block';
}

window.scrollToAIActions = function() {
  const aiActionsSection = document.getElementById('ai-actions-section');
  if (aiActionsSection) {
    aiActionsSection.scrollIntoView({behavior: 'smooth', block: 'start'});
  } else {
    window.scrollTo({top: 0, behavior: 'smooth'});
  }
}

// Simple newline handling for contenteditable fields
function setupSimpleNewlineSupport() {
  const editableElements = document.querySelectorAll('[contenteditable="true"][data-newline-support="true"]');

  editableElements.forEach(element => {
    element.removeEventListener('keydown', handleSimpleEnter);

    element.addEventListener('keydown', handleSimpleEnter);
  });
}

// Simple function to handle Enter key for newlines only
function handleSimpleEnter(e) {
  if (e.key === 'Enter') {
    e.preventDefault();

    insertText('\n');
  }
}

// Helper function to insert text at cursor position
function insertText(text) {
  const selection = window.getSelection();
  if (selection.rangeCount > 0) {
    const range = selection.getRangeAt(0);
    const textNode = document.createTextNode(text);
    range.insertNode(textNode);

    // Move cursor after the inserted text
    range.setStartAfter(textNode);
    range.setEndAfter(textNode);
    selection.removeAllRanges();
    selection.addRange(range);
  }
}

// Add paste event handlers separately
function setupPasteHandlers() {
  const editableElements = document.querySelectorAll('[contenteditable="true"][data-newline-support="true"]');

  editableElements.forEach(element => {
    element.addEventListener('paste', function(e) {
      e.preventDefault();
      const paste = (e.clipboardData || window.clipboardData).getData('text');
      insertText(paste);
    });
  });
}

// Initialize simple newline support when document loads
document.addEventListener('DOMContentLoaded', function() {
  setupSimpleNewlineSupport();
  setupPasteHandlers();


  const resumeContent = document.getElementById('resume-content');
  if (resumeContent) {
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'childList') {
          setupSimpleNewlineSupport();
          setupPasteHandlers();
        }
      });
    });
    observer.observe(resumeContent, { childList: true, subtree: true });
  }
});

// Button-based bullet point insertion for specific work experience field
window.addBulletPointToField = function(buttonElement) {
  const descriptionField = buttonElement.parentElement.previousElementSibling;

  if (descriptionField && descriptionField.contentEditable === 'true') {
    descriptionField.focus();

    const range = document.createRange();
    const selection = window.getSelection();
    range.selectNodeContents(descriptionField);
    range.collapse(false); // false means collapse to end
    selection.removeAllRanges();
    selection.addRange(range);

    const currentText = descriptionField.textContent || '';
    const needsNewline = currentText.length > 0 && !currentText.endsWith('\n');

    if (needsNewline) {
      insertText('\n‚Ä¢ ');
    } else {
      insertText('‚Ä¢ ');
    }
  } else {
    if (typeof window.showNotification === 'function') {
      window.showNotification('Could not find the description field. Please try again.', 'error', 'Field Error');
    }
  }
}

// Section management functions
window.deleteSection = AIHelpers.deleteSection;

window.showAddSectionModal = function() {
  AIHelpers.showModal('add-section-modal');
}

window.hideAddSectionModal = function() {
  AIHelpers.hideModal('add-section-modal');
}

window.addCustomSection = function(sectionTitle) {
  const resumeContent = document.getElementById('resume-content');
  const addButton = resumeContent.querySelector('button[onclick="showAddSectionModal()"]').parentElement;

  const newSection = document.createElement('div');
  newSection.className = 'resume-section mb-3';
  newSection.setAttribute('data-section', sectionTitle.toLowerCase().replace(/\s+/g, '-'));

  const flexContainer = document.createElement('div');
  flexContainer.className = 'flex justify-between items-center mb-2';
  
  const heading = document.createElement('h3');
  heading.className = 'text-sm md:text-base font-semibold text-gray-900 border-b border-gray-300 pb-0.5 flex-grow';
  heading.contentEditable = 'true';
  heading.textContent = sectionTitle;
  
  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'ml-2 text-red-500 hover:text-red-700 text-xs';
  deleteBtn.onclick = function() { deleteSection(this); };
  
  deleteBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
  </svg>`;
  
  flexContainer.appendChild(heading);
  flexContainer.appendChild(deleteBtn);
  
  const contentDiv = document.createElement('div');
  contentDiv.contentEditable = 'true';
  contentDiv.className = 'text-xs md:text-sm text-gray-700';
  contentDiv.textContent = 'Click here to add content...';
  
  newSection.appendChild(flexContainer);
  newSection.appendChild(contentDiv);

  resumeContent.insertBefore(newSection, addButton);
}

// Update extractResumeData to handle new section structure
window.extractResumeData = function() {
  const resumeContent = document.getElementById('resume-content');
  if (!resumeContent) {
    throw new Error('Resume content element not found');
  }
  const resumeData = {
    isValid: true,
    personalInfo: {
      firstName: resumeContent.querySelector('h2').innerText.split(' ')[0],
      lastName: resumeContent.querySelector('h2').innerText.split(' ').slice(1).join(' '),
      title: resumeContent.querySelector('p.text-sm').innerText,
      email: resumeContent.querySelector('.text-xs span:nth-child(1)')?.innerText || '',
      phone: resumeContent.querySelector('.text-xs span:nth-child(2)')?.innerText || '',
      location: resumeContent.querySelector('.text-xs span:nth-child(3)')?.innerText || '',
      summary: resumeContent.querySelector('[data-section="summary"] p')?.innerText || ''
    },
    workExperience: [],
    education: [],
    skills: []
  };

  // Extract work experience
  const workExpSection = resumeContent.querySelector('[data-section="experience"]');
  if (workExpSection) {
    workExpSection.querySelectorAll('.mb-3').forEach(exp => {
      const titleEl = exp.querySelector('h4');
      const companyEl = exp.querySelector('p.text-xs');
      const dateEl = exp.querySelector('.text-xs.text-gray-600');
      const descEl = exp.querySelector('.whitespace-pre-wrap');

      if (titleEl && companyEl && dateEl) {
        const companyText = companyEl.innerText;
        // Parse company and location - format is "Company ‚Äì Location"
        const companyParts = companyText.split('‚Äì');
        const company = companyParts[0]?.trim() || companyText.split(',')[0]?.trim() || '';
        const location = companyParts[1]?.trim() || '';

        const dates = dateEl.innerText.split(' - ');

        resumeData.workExperience.push({
          title: titleEl.innerText,
          company: company,
          location: location,
          startDate: dates[0]?.trim() || '',
          endDate: dates[1]?.trim() || '',
          description: descEl ? descEl.innerText : ''
        });
      }
    });
  }

  // Extract education
  const eduSection = resumeContent.querySelector('[data-section="education"]');
  if (eduSection) {
    eduSection.querySelectorAll('.mb-2').forEach(edu => {
      const degreeEl = edu.querySelector('h4');
      const institutionEl = edu.querySelector('p.text-xs');
      const dateEl = edu.querySelector('.text-xs.text-gray-600');

      if (degreeEl && institutionEl && dateEl) {
        const degreeText = degreeEl.innerText;
        const degreeMatch = degreeText.match(/(.*?)(?:\s+in\s+(.*))?$/);
        const dates = dateEl.innerText.split(' - ');

        resumeData.education.push({
          degree: degreeMatch ? degreeMatch[1] : degreeText,
          fieldOfStudy: degreeMatch && degreeMatch[2] ? degreeMatch[2] : '',
          institution: institutionEl.innerText,
          startDate: dates[0]?.trim() || '',
          endDate: dates[1]?.trim() || ''
        });
      }
    });
  }

  // Extract skills
  const skillsSection = resumeContent.querySelector('[data-section="skills"]');
  if (!skillsSection) {
    // Fallback: try to find skills container directly
    const skillsContainer = resumeContent.querySelector('#skills-container');
    if (skillsContainer) {
      const skillsText = skillsContainer.innerText;
      resumeData.skills = skillsText.split(',').map(skill => skill.trim()).filter(skill => skill);
    }
  } else {
    const skillsContainer = skillsSection.querySelector('#skills-container');
    if (skillsContainer) {
      const skillsText = skillsContainer.innerText;
      resumeData.skills = skillsText.split(',').map(skill => skill.trim()).filter(skill => skill);
    }
  }

  // Extract certifications if present
  resumeData.certifications = [];
  const certSection = resumeContent.querySelector('[data-section="certifications"]');
  if (certSection) {
    certSection.querySelectorAll('.mb-2').forEach(cert => {
      const nameEl = cert.querySelector('h4');
      const orgEl = cert.querySelector('p.text-xs');
      const dateEl = cert.querySelector('.text-xs.text-gray-600');

      if (nameEl && orgEl) {
        const orgText = orgEl.innerText;
        // Parse org and credential ID - format is "Org ‚Ä¢ CredentialID"
        const orgParts = orgText.split('‚Ä¢');
        const dates = dateEl ? dateEl.innerText.split(' - ') : ['', ''];

        resumeData.certifications.push({
          name: nameEl.innerText,
          issuingOrg: orgParts[0]?.trim() || orgText,
          credentialId: orgParts[1]?.trim() || '',
          issueDate: dates[0]?.trim() || '',
          expiryDate: dates[1]?.trim() || ''
        });
      }
    });
  }

  return resumeData;
}

// Function to save the resume to documents
window.saveResumeToDocuments = function(isFromDownload = false) {
  return new Promise((resolve, reject) => {
    let resumeData;
    try {
      resumeData = extractResumeData();
    } catch (error) {
      console.error('Error extracting resume data:', error);
      if (!isFromDownload && typeof window.showNotification === 'function') {
        window.showNotification('Failed to extract resume data: ' + error.message, 'error', 'Save Failed');
      }
      reject(error);
      return;
    }
    const jobID = {{.JobID}};

    if (!jobID) {
      if (!isFromDownload && typeof window.showNotification === 'function') {
        window.showNotification('Unable to save: Job ID not found', 'error', 'Save Failed');
      }
      reject(new Error('Job ID not found'));
      return;
    }

    // Show loading state only if not from download (download has its own loading state)
    let saveButton = null;
    let originalText = '';
    if (!isFromDownload && event && event.target) {
      saveButton = event.target;
      originalText = saveButton.innerText;
      saveButton.disabled = true;
      saveButton.innerText = 'Saving...';
    }

    // Prepare the request data
    const requestData = {
      jobId: jobID,
      documentType: 'resume',
      content: JSON.stringify(resumeData)
    };

    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

    // Send the save request
    fetch('/documents/save', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken
      },
      body: JSON.stringify(requestData)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Failed to save document');
      }
      return response.json();
    })
    .then(data => {
      if (!isFromDownload && typeof window.showNotification === 'function') {
        window.showNotification('Document saved successfully!', 'success', 'Save Complete');
      }
      resolve(data);
    })
    .catch(error => {
      console.error('Error saving resume:', error);
      if (!isFromDownload && typeof window.showNotification === 'function') {
        window.showNotification('Failed to save document. Please try again.', 'error', 'Save Failed');
      }
      reject(error);
    })
    .finally(() => {
      // Restore button state
      if (saveButton) {
        saveButton.disabled = false;
        saveButton.innerText = originalText;
      }
    });
  });
}

// This function is no longer needed as we use window.showNotification
// which is defined in base.html and properly handles toast notifications
})();
</script>

